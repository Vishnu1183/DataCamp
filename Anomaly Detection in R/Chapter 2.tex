######################### Distance and density based anomaly detection #######################

$$$$$$ Exploring wine
# View the contents of the wine data
head(wine)

# Scatterplot of wine pH against alcohol
plot(pH ~ alcohol, data = wine)


$$$$$$ kNN distance matrix
# Calculate the 5 nearest neighbors distance
wine_nn <- get.knn(wine, k = 5)

# View the distance matrix
head(wine_nn$nn.dist)


$$$$$$ kNN distance matrix
# Calculate the 5 nearest neighbors distance
wine_nn <- get.knn(wine, k = 5)

# View the distance matrix
head(wine_nn$nn.dist)

# Distance from wine 5 to nearest neighbor
wine_nn$nn.dist[5,1]


$$$$$$ kNN distance matrix
# Calculate the 5 nearest neighbors distance
wine_nn <- get.knn(wine, k = 5)

# View the distance matrix
head(wine_nn$nn.dist)

# Distance from wine 5 to nearest neighbor
wine_nn$nn.dist[5, 1]

# Row index of wine 5's nearest neighbor 
wine_nn$nn.index[5,1]


$$$$$$ kNN distance matrix
# Calculate the 5 nearest neighbors distance
wine_nn <- get.knn(wine, k = 5)

# View the distance matrix
head(wine_nn$nn.dist)

# Distance from wine 5 to nearest neighbor
wine_nn$nn.dist[5, 1]

# Row index of wine 5's nearest neighbor 
wine_nn$nn.ind[5, 1]

# Return data for wine and its nearest neighbor
wine[c(5, 1751), ]


$$$$$$ kNN distance score
# Calculate the 5 nearest neighbors distance
wine_nn <- get.knn(wine, k = 5)

# Create score by averaging distances
wine_nnd <- rowMeans(wine_nn$nn.dist)

# Print row index of the most anomalous point
which.max(wine_nnd)



$$$$$$ Standardizing features
# Without standardization, features have different scales
summary(wine)

# Standardize the wine columns
wine_scaled <- scale(wine)

# Standardized features have similar means and quartiles
summary(wine_scaled)


$$$$$$ Appending the kNN score
# Print the 5-nearest neighbor distance score
wine_nnd[1:5]

# Append the score as a new column 
wine$score <- wine_nnd


$$$$$$ Visualizing kNN distance score
# Scatterplot showing pH, alcohol and kNN score
plot(pH ~ alcohol, data = wine, cex = sqrt(score), pch = 20)


$$$$$$ LOF calculation
# Calculate the LOF for wine data
wine_lof <- lof(scale(wine), k=5)

# Append the LOF score as a new column
wine$score <- wine_lof

$$$$$$ LOF visualization
# Scatterplot showing pH, alcohol and LOF score
 plot(pH ~ alcohol, data = wine, cex = score, pch = 20)


$$$$$ LOF vs kNN
# Scaled wine data
wine_scaled <- scale(wine)

# Calculate distance matrix
wine_nn <- get.knn(wine_scaled, k =10)

# Append score column to data
wine$score_knn <- rowMeans(wine_nn$nn.dist) 

$$$$$ LOF vs kNN
# Scaled wine data
wine_scaled <- scale(wine)

# Calculate distance matrix
wine_nn <- get.knn(wine_scaled, k = 10)

# Append score column to data
wine$score_knn <- rowMeans(wine_nn$nn.dist)

# Calculate and append LOF as a new column
wine$score_lof <- lof(wine_scaled, k =10)

$$$$$ LOF vs kNN
